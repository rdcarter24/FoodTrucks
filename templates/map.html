<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />

    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
    </style>

    <!-- import google maps API -->
    <script src="http://maps.google.com/maps/api/js?key=AIzaSyB-aXzmKl3zsyKUYJYwFzkQWjU0-hlVklk&sensor=false">
    </script>

    <script>
        function getLocation(){
            //get the users geolocation, function loads automatically with page
            if (navigator.geolocation){
                navigator.geolocation.getCurrentPosition(initialize);
            }
            // do something with this error message
            else{x.innerHTML="Geolocation is not supported by this browser.";}
            }
        var directionsDisplay;
        var directionsService = new google.maps.DirectionsService();

        function initialize(position) {
            // initaialize the map with users location as center
            directionsDisplay = new google.maps.DirectionsRenderer();
            var userLatLng = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            var mapOptions = {
                center: userLatLng,
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };

            var map = new google.maps.Map(document.getElementById("map-canvas"),
                mapOptions);

            // add marker for user
            var user = new google.maps.Marker({
                map: map,
                position: userLatLng,
                title: "user"
            });

            directionsDisplay.setMap(map);

            // add marker for foodtrucks within 2 miles
            var trucks = {{ trucks | safe }};
            for (truck in trucks){
                var location = new google.maps.Geocoder()
                location.geocode( { 'address': trucks[truck][0]}, (function(truck){
                    return function(results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {
                            var truckLatLng = results[0].geometry.location
                            if (google.maps.geometry.spherical.computeDistanceBetween(userLatLng,truckLatLng)<5000){
                                var marker = new google.maps.Marker({
                                    map: map,
                                    position: truckLatLng,
                                    title: truck
                                });
                                console.log(truck)
                                google.maps.event.addListener(marker, 'click', function(){
                                    calcRoute(userLatLng,marker.getPosition())
                                });
                            };
                        }
                    }
                })(truck));
            }
        }


        function calcRoute(userLatLng, truckLatLng) {
            // get directions from user to foodtruck
            var request = {
                origin:userLatLng,
                destination:truckLatLng,//new google.maps.LatLng(latitude, longitude),
                travelMode: google.maps.TravelMode.DRIVING
            };
            directionsService.route(request, function(result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionsDisplay.setDirections(result);
            }
          });
        }

        window.onload = getLocation()

    </script>
  </head>
<body>

    <div id="map-canvas" style="float:left;width:70%; height:100%"></div>

</body>